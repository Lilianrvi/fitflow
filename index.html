// Remplacez votre fonction startScanner existante par cette nouvelle version
async function startScanner(isQuickAdd = false) {
    const modalContent = `
        <div class="glass-card p-6 rounded-3xl w-full max-w-sm text-center flex flex-col h-[80vh]">
            <h2 class="text-xl font-bold mb-4">Scanner un code-barres</h2>
            <p id="scan-status-message" class="text-gray-400 mb-4 h-12 flex items-center justify-center">
                Visez un code-barres...
            </p>
            <div id="interactive" class="flex-grow rounded-lg overflow-hidden"></div>
            <button id="close-scanner-btn" class="w-full mt-4 btn-primary">Annuler</button>
        </div>
    `;

    showModal(modalContent, (modalWrapper) => {
        const scannerContainer = modalWrapper.querySelector('#interactive');
        const statusMessageEl = modalWrapper.querySelector('#scan-status-message');

        const quaggaConfig = {
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: scannerContainer,
                constraints: {
                    facingMode: "environment"
                }
            },
            decoder: {
                readers: ["ean_reader", "code_128_reader", "upc_reader", "upc_e_reader", "ean_8_reader"]
            }
        };

        Quagga.init(quaggaConfig, function (err) {
            if (err) {
                console.error("Erreur lors de l'initialisation de QuaggaJS:", err);
                showToast("Erreur de la caméra. Réessayez.", "error");
                closeModal();
                return;
            }
            Quagga.start();
        });

        Quagga.onProcessed(function(result) {
            const drawingCanvas = Quagga.canvas.dom.overlay;
            if (drawingCanvas) {
                const ctx = drawingCanvas.getContext('2d');
                ctx.clearRect(0, 0, parseInt(drawingCanvas.width), parseInt(drawingCanvas.height));
                if (result) {
                    if (result.boxes) {
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, ctx, { color: "green", lineWidth: 2 });
                        });
                    }
                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, ctx, { color: "#00F", lineWidth: 2 });
                    }
                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, ctx, { color: "red", lineWidth: 3 });
                    }
                }
            }
        });

        let lastCode = null;
        let detectionTimeout = null;

        Quagga.onDetected(async (data) => {
            const decodedCode = data.codeResult.code;

            if (decodedCode && decodedCode !== lastCode) {
                lastCode = decodedCode;
                statusMessageEl.textContent = `Code détecté : ${decodedCode}. Ne bougez plus !`;
                statusMessageEl.classList.add('text-yellow-400');
                statusMessageEl.classList.remove('text-gray-400');

                if (detectionTimeout) clearTimeout(detectionTimeout);
                detectionTimeout = setTimeout(async () => {
                    Quagga.stop();
                    closeModal();

                    try {
                        const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${decodedCode}?fields=product_name_fr,product_name,nutriments,brands,image_url,nutriscore_grade,code&json=1`, {
                            headers: {
                                'User-Agent': 'FitFlowApp/1.0 (fitflow@example.com)'
                            }
                        });
                        const apiData = await response.json();

                        if (apiData.status === 1 && apiData.product) {
                            const product = apiData.product;
                            const nutriments = product.nutriments || {};
                            let calories = nutriments.energy_kcal_100g || 0;
                            if (calories === 0 && nutriments.energy_100g) {
                                calories = nutriments.energy_100g / 4.184;
                            }

                            const formattedFoodItem = {
                                code: product.code,
                                name: product.product_name_fr || product.product_name || 'Aliment inconnu',
                                brand: product.brands || null,
                                calories: Math.round(calories),
                                protein: nutriments.proteins_100g || 0,
                                fat: nutriments.fat_100g || 0,
                                carbs: nutriments.carbohydrates_100g || 0,
                                sugars: nutriments.sugars_100g || 0,
                                fiber: nutriments.fiber_100g || 0,
                                nutri_score: product.nutriscore_grade || 'unknown',
                                imageUrl: product.image_url || null,
                            };

                            addIngredientToMeal(formattedFoodItem, isQuickAdd);
                            showToast("Produit trouvé !", "success");

                        } else {
                            showToast("Produit non trouvé.", "error");
                        }
                    } catch (error) {
                        console.error('Erreur lors de la recherche du code-barres:', error);
                        showToast("Erreur de connexion à l'API.", "error");
                    }
                }, 1000); // Délai de 1s pour la confirmation du code-barres
            }
        });

        modalWrapper.querySelector('#close-scanner-btn').onclick = () => {
            Quagga.stop();
            closeModal();
            if (detectionTimeout) clearTimeout(detectionTimeout);
        };
    });
}
